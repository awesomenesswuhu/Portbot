<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ðŸ‘´ PortBot - Krishna's Proud Digital Grandpa</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Crimson+Pro:ital,wght@0,400;0,600;1,400&family=DM+Sans:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-warm: #FDF6E9;
            --bg-cream: #FFF9F0;
            --bg-card: #FFFFFF;
            --accent-burgundy: #8B3A3A;
            --accent-gold: #C4956A;
            --accent-sage: #7D9471;
            --text-dark: #3D3232;
            --text-muted: #6B5B5B;
            --border-soft: #E8DED4;
            --shadow-warm: rgba(139, 58, 58, 0.08);
            --grandpa-bubble: #FFF5EB;
            --user-bubble: #F0E6DC;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'DM Sans', sans-serif;
            background: var(--bg-warm);
            color: var(--text-dark);
            height: 100vh;
            overflow: hidden;
        }

        .app-container {
            display: flex;
            height: 100vh;
        }

        /* Project Preview Panel */
        .preview-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--bg-cream);
            border-right: 1px solid var(--border-soft);
        }

        .preview-header {
            padding: 16px 24px;
            background: var(--bg-card);
            border-bottom: 1px solid var(--border-soft);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .preview-header h2 {
            font-family: 'Crimson Pro', serif;
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--accent-burgundy);
        }

        .preview-url {
            flex: 1;
            padding: 8px 14px;
            background: var(--bg-warm);
            border: 1px solid var(--border-soft);
            border-radius: 8px;
            font-size: 0.85rem;
            color: var(--text-muted);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .preview-frame-container {
            flex: 1;
            position: relative;
            background: linear-gradient(135deg, var(--bg-cream) 0%, var(--bg-warm) 100%);
        }

        .preview-placeholder {
            position: absolute;
            inset: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 40px;
        }

        .preview-placeholder .emoji {
            font-size: 4rem;
            margin-bottom: 20px;
            animation: gentle-bounce 3s ease-in-out infinite;
        }

        @keyframes gentle-bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .preview-placeholder h3 {
            font-family: 'Crimson Pro', serif;
            font-size: 1.75rem;
            color: var(--accent-burgundy);
            margin-bottom: 12px;
        }

        .preview-placeholder p {
            color: var(--text-muted);
            max-width: 400px;
            line-height: 1.6;
        }

        .preview-frame {
            width: 100%;
            height: 100%;
            border: none;
            display: none;
        }

        .preview-frame.active {
            display: block;
        }

        /* Chat Panel */
        .chat-panel {
            width: 420px;
            min-width: 380px;
            display: flex;
            flex-direction: column;
            background: var(--bg-card);
            box-shadow: -4px 0 24px var(--shadow-warm);
        }

        .chat-header {
            padding: 20px 24px;
            background: linear-gradient(135deg, var(--accent-burgundy) 0%, #6B2A2A 100%);
            color: white;
        }

        .chat-header-content {
            display: flex;
            align-items: center;
            gap: 14px;
        }

        .grandpa-avatar {
            width: 56px;
            height: 56px;
            background: var(--bg-warm);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .chat-header h1 {
            font-family: 'Crimson Pro', serif;
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 2px;
        }

        .chat-header p {
            font-size: 0.85rem;
            opacity: 0.9;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 16px;
            background: linear-gradient(180deg, var(--bg-cream) 0%, var(--bg-card) 100%);
        }

        .message {
            max-width: 90%;
            animation: message-in 0.3s ease-out;
        }

        @keyframes message-in {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.grandpa {
            align-self: flex-start;
        }

        .message.user {
            align-self: flex-end;
        }

        .message-bubble {
            padding: 14px 18px;
            border-radius: 18px;
            line-height: 1.6;
            font-size: 0.95rem;
        }

        .message.grandpa .message-bubble {
            background: var(--grandpa-bubble);
            border: 1px solid var(--border-soft);
            border-bottom-left-radius: 4px;
        }

        .message.user .message-bubble {
            background: var(--accent-burgundy);
            color: white;
            border-bottom-right-radius: 4px;
        }

        .message-bubble p {
            margin-bottom: 8px;
        }

        .message-bubble p:last-child {
            margin-bottom: 0;
        }

        .message-bubble a {
            color: var(--accent-burgundy);
            text-decoration: none;
            font-weight: 500;
            padding: 6px 12px;
            background: rgba(139, 58, 58, 0.1);
            border-radius: 6px;
            display: inline-block;
            margin: 4px 0;
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .message-bubble a:hover {
            background: var(--accent-burgundy);
            color: white;
        }

        .message.user .message-bubble a {
            color: white;
            background: rgba(255,255,255,0.2);
        }

        .message.user .message-bubble a:hover {
            background: rgba(255,255,255,0.3);
        }

        .message-bubble strong {
            color: var(--accent-burgundy);
        }

        .message.user .message-bubble strong {
            color: white;
        }

        .typing-indicator {
            display: flex;
            gap: 4px;
            padding: 14px 18px;
            background: var(--grandpa-bubble);
            border: 1px solid var(--border-soft);
            border-radius: 18px;
            border-bottom-left-radius: 4px;
            width: fit-content;
        }

        .typing-indicator span {
            width: 8px;
            height: 8px;
            background: var(--accent-gold);
            border-radius: 50%;
            animation: typing-bounce 1.4s ease-in-out infinite;
        }

        .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typing-bounce {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-6px); }
        }

        .chat-input-container {
            padding: 16px 20px;
            background: var(--bg-card);
            border-top: 1px solid var(--border-soft);
        }

        .chat-input-wrapper {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }

        .chat-input {
            flex: 1;
            padding: 14px 18px;
            border: 2px solid var(--border-soft);
            border-radius: 24px;
            font-family: inherit;
            font-size: 0.95rem;
            resize: none;
            max-height: 120px;
            transition: border-color 0.2s ease;
            background: var(--bg-cream);
        }

        .chat-input:focus {
            outline: none;
            border-color: var(--accent-burgundy);
        }

        .chat-input::placeholder {
            color: var(--text-muted);
        }

        .send-button {
            width: 48px;
            height: 48px;
            background: var(--accent-burgundy);
            border: none;
            border-radius: 50%;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            flex-shrink: 0;
        }

        .send-button:hover {
            background: #6B2A2A;
            transform: scale(1.05);
        }

        .send-button:disabled {
            background: var(--border-soft);
            cursor: not-allowed;
            transform: none;
        }

        .send-button svg {
            width: 20px;
            height: 20px;
        }

        .reset-button {
            padding: 8px 16px;
            background: transparent;
            border: 1px solid var(--border-soft);
            border-radius: 20px;
            font-size: 0.8rem;
            color: var(--text-muted);
            cursor: pointer;
            transition: all 0.2s ease;
            margin-top: 10px;
            width: 100%;
        }

        .reset-button:hover {
            background: var(--bg-warm);
            border-color: var(--accent-gold);
            color: var(--text-dark);
        }

        /* Scrollbar styling */
        .chat-messages::-webkit-scrollbar {
            width: 6px;
        }

        .chat-messages::-webkit-scrollbar-track {
            background: transparent;
        }

        .chat-messages::-webkit-scrollbar-thumb {
            background: var(--border-soft);
            border-radius: 3px;
        }

        .chat-messages::-webkit-scrollbar-thumb:hover {
            background: var(--accent-gold);
        }

        /* Responsive */
        @media (max-width: 900px) {
            .app-container {
                flex-direction: column-reverse;
            }

            .chat-panel {
                width: 100%;
                min-width: unset;
                height: 60vh;
            }

            .preview-panel {
                height: 40vh;
                border-right: none;
                border-top: 1px solid var(--border-soft);
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Project Preview Panel -->
        <div class="preview-panel">
            <div class="preview-header">
                <h2>ðŸ“„ Project Preview</h2>
                <div class="preview-url" id="previewUrl">Click a project link to preview it here</div>
            </div>
            <div class="preview-frame-container">
                <div class="preview-placeholder" id="previewPlaceholder">
                    <div class="emoji">ðŸ‘´ðŸ“š</div>
                    <h3>Welcome to Krishna's Portfolio!</h3>
                    <p>Chat with Grandpa on the right, and when he recommends a project, click the link to preview it right here. He's very proud of his granddaughter's work!</p>
                </div>
                <iframe class="preview-frame" id="previewFrame" sandbox="allow-same-origin allow-scripts allow-popups allow-forms"></iframe>
            </div>
        </div>

        <!-- Chat Panel -->
        <div class="chat-panel">
            <div class="chat-header">
                <div class="chat-header-content">
                    <div class="grandpa-avatar">ðŸ‘´</div>
                    <div>
                        <h1>Grandpa Bot</h1>
                        <p>Krishna's Proud Digital Grandpa</p>
                    </div>
                </div>
            </div>

            <div class="chat-messages" id="chatMessages">
                <!-- Messages will be inserted here -->
            </div>

            <div class="chat-input-container">
                <div class="chat-input-wrapper">
                    <textarea 
                        class="chat-input" 
                        id="chatInput" 
                        placeholder="Ask grandpa about Krishna's projects..."
                        rows="1"
                    ></textarea>
                    <button class="send-button" id="sendButton" title="Send message">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <line x1="22" y1="2" x2="11" y2="13"></line>
                            <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                        </svg>
                    </button>
                </div>
                <button class="reset-button" id="resetButton">ðŸ”„ Start New Conversation</button>
            </div>
        </div>
    </div>

    <script>
        const chatMessages = document.getElementById('chatMessages');
        const chatInput = document.getElementById('chatInput');
        const sendButton = document.getElementById('sendButton');
        const resetButton = document.getElementById('resetButton');
        const previewFrame = document.getElementById('previewFrame');
        const previewPlaceholder = document.getElementById('previewPlaceholder');
        const previewUrl = document.getElementById('previewUrl');

        let isLoading = false;

        // Auto-resize textarea
        chatInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 120) + 'px';
        });

        // Send on Enter (Shift+Enter for new line)
        chatInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        sendButton.addEventListener('click', sendMessage);
        resetButton.addEventListener('click', resetConversation);

        // Initial greeting
        window.addEventListener('load', () => {
            sendMessage("Hello! I just arrived at Krishna's portfolio.", true);
        });

        async function sendMessage(overrideMessage = null, isInitial = false) {
            const message = overrideMessage || chatInput.value.trim();
            if (!message || isLoading) return;

            isLoading = true;
            sendButton.disabled = true;

            // Add user message (skip for initial greeting)
            if (!isInitial) {
                addMessage(message, 'user');
                chatInput.value = '';
                chatInput.style.height = 'auto';
            }

            // Show typing indicator
            const typingDiv = document.createElement('div');
            typingDiv.className = 'message grandpa';
            typingDiv.innerHTML = `
                <div class="typing-indicator">
                    <span></span><span></span><span></span>
                </div>
            `;
            chatMessages.appendChild(typingDiv);
            scrollToBottom();

            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message })
                });

                const data = await response.json();
                
                // Remove typing indicator
                typingDiv.remove();

                if (data.success) {
                    addMessage(data.response, 'grandpa');
                } else {
                    addMessage("Oh dear, something went wrong! Let me try again... *adjusts glasses*", 'grandpa');
                }
            } catch (error) {
                typingDiv.remove();
                addMessage("Oh my, I seem to be having trouble connecting. Please check if the server is running!", 'grandpa');
            }

            isLoading = false;
            sendButton.disabled = false;
            chatInput.focus();
        }

        function addMessage(text, sender) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            
            // Parse markdown-style links and convert to clickable
            const formattedText = formatMessage(text);
            
            messageDiv.innerHTML = `<div class="message-bubble">${formattedText}</div>`;
            chatMessages.appendChild(messageDiv);
            scrollToBottom();

            // Add click handlers to links
            messageDiv.querySelectorAll('a[data-project-url]').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    loadProject(link.dataset.projectUrl);
                });
            });
        }

        function formatMessage(text) {
            // Convert markdown links [text](url) to clickable project links
            let formatted = text.replace(/\[([^\]]+)\]\((https?:\/\/[^\)]+)\)/g, (match, linkText, url) => {
                return `<a href="#" data-project-url="${url}">ðŸ‘‰ ${linkText}</a>`;
            });

            // Also catch raw URLs that aren't already in links (fallback)
            formatted = formatted.replace(/(^|[^"'>])(https?:\/\/[^\s<]+)/g, (match, prefix, url) => {
                // Don't double-wrap URLs that are already in data-project-url
                if (prefix.includes('data-project-url')) return match;
                return `${prefix}<a href="#" data-project-url="${url}">ðŸ”— ${url.length > 50 ? url.substring(0, 50) + '...' : url}</a>`;
            });

            // Convert **bold** to <strong>
            formatted = formatted.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');

            // Convert *italic* to <em>
            formatted = formatted.replace(/\*([^*]+)\*/g, '<em>$1</em>');

            // Convert newlines to paragraphs
            formatted = formatted.split('\n\n').map(p => `<p>${p.replace(/\n/g, '<br>')}</p>`).join('');

            return formatted;
        }

        function loadProject(url) {
            previewPlaceholder.style.display = 'none';
            previewFrame.classList.add('active');
            previewFrame.src = url;
            previewUrl.textContent = url;
        }

        async function resetConversation() {
            try {
                await fetch('/api/reset', { method: 'POST' });
                chatMessages.innerHTML = '';
                previewPlaceholder.style.display = 'flex';
                previewFrame.classList.remove('active');
                previewFrame.src = '';
                previewUrl.textContent = 'Click a project link to preview it here';
                
                // Get new greeting
                sendMessage("Hello! I just arrived at Krishna's portfolio.", true);
            } catch (error) {
                console.error('Failed to reset:', error);
            }
        }

        function scrollToBottom() {
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
    </script>
</body>
</html>
